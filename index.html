<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rifki &amp; Sinta: Penjelajah Dimensi Ilmu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&amp;family=Fredoka+One&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Nunito', sans-serif;
    }
    
    .title-font {
      font-family: 'Fredoka One', cursive;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(2deg); }
    }
    
    @keyframes pulse-glow {
      0%, 100% { filter: drop-shadow(0 0 10px rgba(147, 51, 234, 0.5)); }
      50% { filter: drop-shadow(0 0 25px rgba(147, 51, 234, 0.8)); }
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
      50% { opacity: 1; transform: scale(1) rotate(180deg); }
    }
    
    @keyframes slide-up {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slide-down {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slide-left {
      from { opacity: 0; transform: translateX(50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slide-right {
      from { opacity: 0; transform: translateX(-50px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes bounce-in {
      0% { transform: scale(0) rotateX(100deg); opacity: 0; }
      50% { transform: scale(1.1) rotateX(0deg); }
      100% { transform: scale(1) rotateX(0deg); opacity: 1; }
    }
    
    @keyframes fog-drift {
      0% { transform: translateX(-100%); opacity: 0.3; }
      50% { opacity: 0.6; }
      100% { transform: translateX(100%); opacity: 0.3; }
    }
    
    @keyframes star-twinkle {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes rotate-360 {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    @keyframes swing {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    @keyframes morph {
      0%, 100% { border-radius: 60% 40% 30% 70%; }
      50% { border-radius: 30% 60% 70% 40%; }
    }
    
    @keyframes glow-pulse {
      0%, 100% { box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); }
      50% { box-shadow: 0 0 30px rgba(139, 92, 246, 0.8), 0 0 60px rgba(139, 92, 246, 0.5); }
    }
    
    @keyframes flip {
      0% { transform: rotateY(0deg); }
      100% { transform: rotateY(360deg); }
    }
    
    @keyframes slide-up-fade {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fade-in-scale {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .float-animation {
      animation: float 3s ease-in-out infinite;
    }
    
    .pulse-glow {
      animation: pulse-glow 2s ease-in-out infinite;
    }
    
    .slide-up {
      animation: slide-up 0.6s ease-out forwards;
    }
    
    .slide-down {
      animation: slide-down 0.6s ease-out forwards;
    }
    
    .slide-left {
      animation: slide-left 0.6s ease-out forwards;
    }
    
    .slide-right {
      animation: slide-right 0.6s ease-out forwards;
    }
    
    .bounce-in {
      animation: bounce-in 0.7s ease-out forwards;
    }
    
    .fog-effect {
      animation: fog-drift 15s linear infinite;
    }
    
    .star-twinkle {
      animation: star-twinkle 2s ease-in-out infinite;
    }
    
    .stagger-1 { animation-delay: 0.1s; }
    .stagger-2 { animation-delay: 0.2s; }
    .stagger-3 { animation-delay: 0.3s; }
    .stagger-4 { animation-delay: 0.4s; }
    .stagger-5 { animation-delay: 0.5s; }
    
    .game-card {
      transition: all 0.3s ease;
      transform-style: preserve-3d;
    }
    
    .game-card:hover {
      transform: translateY(-8px) scale(1.02);
    }
    
    .chapter-node {
      transition: all 0.3s ease;
    }
    
    .chapter-node:hover:not(.locked) {
      transform: scale(1.1);
      filter: brightness(1.2);
    }
    
    .dialog-box {
      background: linear-gradient(135deg, rgba(30, 27, 75, 0.95), rgba(49, 46, 129, 0.95));
      border: 3px solid rgba(167, 139, 250, 0.5);
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.3), inset 0 0 60px rgba(139, 92, 246, 0.1);
      animation: glow-pulse 3s ease-in-out infinite;
    }
    
    .puzzle-cell {
      transition: all 0.3s ease;
      animation: fade-in-scale 0.5s ease-out forwards;
    }
    
    .puzzle-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
    }
    
    .blur-effect {
      filter: blur(3px);
      transition: filter 0.5s ease;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    .character-sprite {
      image-rendering: crisp-edges;
    }
    
    .cosmic-bg {
      background: radial-gradient(ellipse at center, #1e1b4b 0%, #0f0a1e 50%, #030014 100%);
    }
    
    .island-glow {
      filter: drop-shadow(0 0 20px currentColor);
    }
    
    .button-pulse {
      animation: pulse 2s ease-in-out infinite;
    }
    
    .rotate-spin {
      animation: rotate-360 20s linear infinite;
    }
    
    .swing-animation {
      animation: swing 1.5s ease-in-out infinite;
      transform-origin: top center;
    }
    
    .morph-shape {
      animation: morph 4s ease-in-out infinite;
    }
    
    .flip-animation {
      animation: flip 3s ease-in-out infinite;
    }
    
    .shake-animation {
      animation: shake 0.5s ease-in-out;
    }
    
    .question-slide {
      animation: slide-up-fade 0.8s ease-out forwards;
    }
    
    .option-stagger {
      animation: bounce-in 0.6s ease-out forwards;
    }

    .mini-sparkle {
      position: absolute;
      animation: sparkle 1s ease-in-out;
    }
    
    .rotate-spin-slow {
      animation: rotate-360 4s linear infinite;
    }
    
    .rotate-spin-slow.paused {
      animation: none;
      opacity: 0.5;
    }
    
    .tooltip-container {
      position: relative;
    }
    
    .tooltip-container:hover .tooltip {
      opacity: 1;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full overflow-auto cosmic-bg text-white">
  <div id="app" class="min-h-full w-full relative"><!-- Animated Stars Background -->
   <div id="stars-container" class="fixed inset-0 pointer-events-none overflow-hidden"><!-- Stars generated by JS -->
   </div><!-- Fog Effect (Si Lupa's presence) -->
   <div class="fixed inset-0 pointer-events-none overflow-hidden opacity-20">
    <div class="absolute inset-0 bg-gradient-to-r from-purple-900/30 via-transparent to-purple-900/30 fog-effect"></div>
   </div><!-- Main Menu Screen -->
   <div id="main-menu" class="min-h-full w-full flex flex-col items-center justify-center p-4 relative z-10"><!-- Lensa Kosmos Logo -->
    <div class="relative mb-6 float-animation">
     <svg viewbox="0 0 200 200" class="w-32 h-32 md:w-40 md:h-40 pulse-glow"><defs>
       <lineargradient id="lensGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#a78bfa" />
        <stop offset="50%" style="stop-color:#8b5cf6" />
        <stop offset="100%" style="stop-color:#6d28d9" />
       </lineargradient>
       <radialgradient id="innerGlow" cx="50%" cy="50%" r="50%">
        <stop offset="0%" style="stop-color:#c4b5fd;stop-opacity:0.8" />
        <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:0" />
       </radialgradient>
      </defs> <circle cx="100" cy="100" r="80" fill="url(#lensGradient)" stroke="#c4b5fd" stroke-width="4" /> <circle cx="100" cy="100" r="60" fill="url(#innerGlow)" /> <circle cx="100" cy="100" r="40" fill="none" stroke="#e9d5ff" stroke-width="2" opacity="0.5" /> <circle cx="100" cy="100" r="20" fill="#fef3c7" opacity="0.9" /> <circle cx="85" cy="85" r="8" fill="white" opacity="0.6" /> <!-- Cosmic rays --> <g stroke="#fcd34d" stroke-width="2" opacity="0.7">
       <line x1="100" y1="10" x2="100" y2="30" />
       <line x1="100" y1="170" x2="100" y2="190" />
       <line x1="10" y1="100" x2="30" y2="100" />
       <line x1="170" y1="100" x2="190" y2="100" />
       <line x1="30" y1="30" x2="45" y2="45" />
       <line x1="155" y1="155" x2="170" y2="170" />
       <line x1="170" y1="30" x2="155" y2="45" />
       <line x1="30" y1="170" x2="45" y2="155" />
      </g>
     </svg>
     <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 text-xs text-purple-300 whitespace-nowrap slide-up">
      Lensa Kosmos
     </div>
    </div><!-- Game Title -->
    <h1 id="game-title" class="title-font text-3xl md:text-5xl lg:text-6xl text-center mb-2 bg-gradient-to-r from-amber-300 via-yellow-200 to-amber-300 bg-clip-text text-transparent drop-shadow-lg slide-down">Rifki &amp; Sinta</h1>
    <h2 class="text-lg md:text-2xl text-purple-300 mb-8 text-center slide-down stagger-2">Penjelajah Dimensi Ilmu</h2><!-- Welcome Message -->
    <p id="welcome-msg" class="text-purple-200 text-center mb-8 max-w-md px-4 slide-up stagger-3">Selamat datang, Penjelajah! Dunia pengetahuan menunggumu.</p><!-- Character Showcase -->
    <div class="flex gap-8 md:gap-16 mb-8 slide-up stagger-4"><!-- Rifki -->
     <div class="text-center game-card cursor-pointer hover:animate-bounce" onclick="showCharacterInfo('rifki')">
      <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center mb-2 border-4 border-blue-300 shadow-lg shadow-blue-500/30 bounce-in stagger-1">
       <svg viewbox="0 0 100 100" class="w-20 h-20 md:w-28 md:h-28 swing-animation"><circle cx="50" cy="40" r="25" fill="#fcd9b6" /> <ellipse cx="50" cy="75" rx="30" ry="20" fill="#3b82f6" /> <circle cx="42" cy="38" r="4" fill="#1e293b" /> <circle cx="58" cy="38" r="4" fill="#1e293b" /> <path d="M45 48 Q50 52 55 48" stroke="#1e293b" stroke-width="2" fill="none" /> <path d="M30 25 Q50 10 70 25 Q65 35 50 30 Q35 35 30 25" fill="#1e293b" /> <rect x="35" y="32" width="30" height="8" rx="2" fill="#60a5fa" opacity="0.5" />
       </svg>
      </div>
      <p class="font-bold text-blue-300">Rifki</p>
      <p class="text-xs text-blue-200">Ahli Logika</p>
     </div><!-- Sinta -->
     <div class="text-center game-card cursor-pointer hover:animate-bounce" onclick="showCharacterInfo('sinta')">
      <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-gradient-to-br from-pink-400 to-rose-500 flex items-center justify-center mb-2 border-4 border-pink-300 shadow-lg shadow-pink-500/30 bounce-in stagger-2">
       <svg viewbox="0 0 100 100" class="w-20 h-20 md:w-28 md:h-28 swing-animation" style="animation-delay: 0.2s;"><circle cx="50" cy="40" r="25" fill="#fcd9b6" /> <ellipse cx="50" cy="75" rx="30" ry="20" fill="#ec4899" /> <circle cx="42" cy="38" r="4" fill="#1e293b" /> <circle cx="58" cy="38" r="4" fill="#1e293b" /> <path d="M45 48 Q50 52 55 48" stroke="#1e293b" stroke-width="2" fill="none" /> <path d="M25 35 Q30 15 50 20 Q70 15 75 35 Q70 45 50 55 Q30 45 25 35" fill="#1e293b" /> <circle cx="30" cy="42" r="4" fill="#fca5a5" opacity="0.5" /> <circle cx="70" cy="42" r="4" fill="#fca5a5" opacity="0.5" />
       </svg>
      </div>
      <p class="font-bold text-pink-300">Sinta</p>
      <p class="text-xs text-pink-200">Ahli Observasi</p>
     </div>
    </div><!-- Menu Buttons -->
    <div class="flex flex-col gap-3 w-full max-w-xs slide-up stagger-5"><button onclick="startNewGame()" class="w-full py-4 px-6 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 rounded-xl font-bold text-lg shadow-lg shadow-emerald-500/30 transform transition-all hover:scale-105 active:scale-95 relative overflow-hidden group"> <span class="relative z-10">üöÄ Mulai Petualangan</span>
      <div class="absolute inset-0 bg-gradient-to-r from-emerald-600 to-teal-600 opacity-0 group-hover:opacity-100 transition-opacity"></div></button> <button onclick="continueGame()" id="continue-btn" class="w-full py-4 px-6 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-xl font-bold text-lg shadow-lg shadow-amber-500/30 transform transition-all hover:scale-105 active:scale-95 hidden"> üìñ Lanjutkan </button> <button onclick="showAchievements()" class="w-full py-3 px-6 bg-gradient-to-r from-purple-600 to-violet-600 hover:from-purple-500 hover:to-violet-500 rounded-xl font-semibold shadow-lg shadow-purple-500/30 transform transition-all hover:scale-105 active:scale-95"> üèÜ Pencapaian </button> <button onclick="showEncyclopedia()" class="w-full py-3 px-6 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 rounded-xl font-semibold shadow-lg shadow-purple-500/30 transform transition-all hover:scale-105 active:scale-95"> üìö Ensiklopedia </button>
    </div><!-- Player Stats (if saved) -->
    <div id="player-stats" class="mt-6 text-center hidden">
     <p class="text-purple-300 text-sm">Penjelajah: <span id="player-name-display" class="text-amber-300 font-bold"></span></p>
     <p class="text-purple-300 text-sm">Skor: <span id="player-score-display" class="text-emerald-300 font-bold"></span></p>
    </div>
   </div><!-- Name Input Screen -->
   <div id="name-input-screen" class="min-h-full w-full flex flex-col items-center justify-center p-4 relative z-10 hidden">
    <div class="dialog-box rounded-2xl p-8 max-w-md w-full slide-up">
     <div class="text-center mb-6">
      <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center bounce-in"><span class="text-4xl flip-animation">üåü</span>
      </div>
      <h2 class="title-font text-2xl text-amber-300 mb-2">Profesor Alpha</h2>
      <p class="text-purple-200">"Selamat datang di Dimensi Ilmu! Siapakah namamu, penjelajah muda?"</p>
     </div><input type="text" id="player-name-input" placeholder="Masukkan namamu..." class="w-full p-4 rounded-xl bg-indigo-900/50 border-2 border-purple-400 text-white placeholder-purple-300 focus:outline-none focus:border-amber-400 mb-4 transition-all"> <button onclick="confirmName()" class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-xl font-bold text-lg transform transition-all hover:scale-105 active:scale-95"> ‚ú® Mulai Petualangan </button>
    </div>
   </div><!-- Chapter Selection / World Map -->
   <div id="world-map" class="min-h-full w-full flex flex-col relative z-10 hidden overflow-auto"><!-- Header Bar -->
    <div class="sticky top-0 bg-gradient-to-r from-indigo-900/90 to-purple-900/90 backdrop-blur border-b border-purple-500/30 p-4 z-20">
     <div class="max-w-6xl mx-auto">
      <div class="flex justify-between items-center mb-3"><button onclick="returnToMenu()" class="p-2 bg-purple-700/50 hover:bg-purple-600/50 rounded-lg transition-colors text-sm font-semibold hover:scale-110 transform"> ‚Üê Kembali </button>
       <div class="flex gap-8">
        <div class="text-center">
         <p class="text-purple-400 text-xs uppercase tracking-wide">Penjelajah</p>
         <p id="map-player-name" class="text-amber-300 font-bold"></p>
        </div>
        <div class="text-center">
         <p class="text-purple-400 text-xs uppercase tracking-wide">Skor Total</p>
         <p id="map-score" class="text-emerald-300 font-bold">0</p>
        </div>
       </div>
      </div>
      <h1 class="title-font text-3xl md:text-4xl text-center text-transparent bg-gradient-to-r from-amber-300 via-yellow-200 to-amber-300 bg-clip-text slide-down">‚ú® Peta Dimensi Ilmu ‚ú®</h1>
     </div>
    </div><!-- Main Content -->
    <div class="flex-1 p-6 overflow-auto">
     <div class="max-w-6xl mx-auto"><!-- Story Context -->
      <div class="dialog-box rounded-xl p-4 mb-8 slide-up">
       <div class="flex items-start gap-3"><span class="text-3xl flip-animation">üåü</span>
        <div>
         <p class="text-amber-300 font-bold mb-1">Profesor Alpha</p>
         <p class="text-purple-200 text-sm">"Selamat datang kembali! Dimensi Ilmu terbagi menjadi 5 pulau berbeda. Jelajahi mereka satu per satu untuk mengalahkan Kabut Lupa dan menyelamatkan pengetahuan!"</p>
        </div>
       </div>
      </div><!-- Chapter Grid -->
      <div class="space-y-4 mb-8"><!-- Chapter 1 -->
       <div class="chapter-card group cursor-pointer option-stagger stagger-1" onclick="selectChapter(1)">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-emerald-600 to-teal-700 p-6 border-2 border-emerald-400/30 hover:border-emerald-400 transition-all group-hover:shadow-2xl group-hover:shadow-emerald-500/50">
         <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <div class="absolute top-0 right-0 w-40 h-40 bg-emerald-400/20 rounded-full blur-3xl animate-pulse"></div>
         </div>
         <div class="relative flex items-center gap-6">
          <div class="flex-shrink-0 w-20 h-20 rounded-xl bg-emerald-400/30 flex items-center justify-center border-2 border-emerald-300/50 group-hover:scale-110 group-hover:rotate-12 transition-transform"><span class="text-4xl group-hover:animate-bounce">üö™</span>
          </div>
          <div class="flex-1">
           <h3 class="title-font text-2xl text-emerald-100 mb-1">Gerbang Pengetahuan</h3>
           <p class="text-emerald-200/80 text-sm mb-3">Tutorial &amp; Bahasa Indonesia ‚Ä¢ Pelajari dasar-dasar penjelajahan</p>
           <div class="flex items-center gap-2">
            <div class="h-2 bg-emerald-900/50 rounded-full flex-1">
             <div class="h-2 bg-emerald-400 rounded-full progress-bar" style="width: 0%"></div>
            </div><span class="text-xs text-emerald-300">Belum dimulai</span>
           </div>
          </div>
          <div class="flex-shrink-0 text-3xl group-hover:translate-x-1 transition-transform group-hover:animate-pulse">
           ‚Üí
          </div>
         </div>
        </div>
       </div><!-- Chapter 2 -->
       <div class="chapter-card group cursor-pointer option-stagger stagger-2" onclick="selectChapter(2)">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-green-600 to-emerald-700 p-6 border-2 border-green-400/30 hover:border-green-400 transition-all group-hover:shadow-2xl group-hover:shadow-green-500/50">
         <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <div class="absolute top-0 right-0 w-40 h-40 bg-green-400/20 rounded-full blur-3xl animate-pulse"></div>
         </div>
         <div class="relative flex items-center gap-6">
          <div class="flex-shrink-0 w-20 h-20 rounded-xl bg-green-400/30 flex items-center justify-center border-2 border-green-300/50 group-hover:scale-110 group-hover:-rotate-12 transition-transform"><span class="text-4xl group-hover:animate-bounce" style="animation-delay: 0.1s;">üåø</span>
          </div>
          <div class="flex-1">
           <h3 class="title-font text-2xl text-green-100 mb-1">Rimba Bioma</h3>
           <p class="text-green-200/80 text-sm mb-3">IPA - Fotosintesis, organ tubuh, evolusi ‚Ä¢ Mode Sinta (Observasi)</p>
           <div class="flex items-center gap-2">
            <div class="h-2 bg-green-900/50 rounded-full flex-1">
             <div class="h-2 bg-green-400 rounded-full progress-bar" style="width: 0%"></div>
            </div><span class="text-xs text-green-300">Terbuka</span>
           </div>
          </div>
          <div class="flex-shrink-0 text-3xl group-hover:translate-x-1 transition-transform group-hover:animate-pulse">
           ‚Üí
          </div>
         </div>
        </div>
       </div><!-- Chapter 3 -->
       <div class="chapter-card group cursor-pointer option-stagger stagger-3" onclick="selectChapter(3)">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-blue-600 to-indigo-700 p-6 border-2 border-blue-400/30 hover:border-blue-400 transition-all group-hover:shadow-2xl group-hover:shadow-blue-500/50">
         <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <div class="absolute top-0 right-0 w-40 h-40 bg-blue-400/20 rounded-full blur-3xl animate-pulse"></div>
         </div>
         <div class="relative flex items-center gap-6">
          <div class="flex-shrink-0 w-20 h-20 rounded-xl bg-blue-400/30 flex items-center justify-center border-2 border-blue-300/50 group-hover:scale-110 group-hover:rotate-12 transition-transform"><span class="text-4xl group-hover:animate-bounce" style="animation-delay: 0.2s;">üî¢</span>
          </div>
          <div class="flex-1">
           <h3 class="title-font text-2xl text-blue-100 mb-1">Kota Numerik</h3>
           <p class="text-blue-200/80 text-sm mb-3">Matematika - Aljabar, statistik, geometri ‚Ä¢ Mode Rifki (Logika)</p>
           <div class="flex items-center gap-2">
            <div class="h-2 bg-blue-900/50 rounded-full flex-1">
             <div class="h-2 bg-blue-400 rounded-full progress-bar" style="width: 0%"></div>
            </div><span class="text-xs text-blue-300">Terbuka</span>
           </div>
          </div>
          <div class="flex-shrink-0 text-3xl group-hover:translate-x-1 transition-transform group-hover:animate-pulse">
           ‚Üí
          </div>
         </div>
        </div>
       </div><!-- Chapter 4 -->
       <div class="chapter-card group cursor-pointer option-stagger stagger-4" onclick="selectChapter(4)">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-amber-600 to-orange-700 p-6 border-2 border-amber-400/30 hover:border-amber-400 transition-all group-hover:shadow-2xl group-hover:shadow-amber-500/50">
         <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
          <div class="absolute top-0 right-0 w-40 h-40 bg-amber-400/20 rounded-full blur-3xl animate-pulse"></div>
         </div>
         <div class="relative flex items-center gap-6">
          <div class="flex-shrink-0 w-20 h-20 rounded-xl bg-amber-400/30 flex items-center justify-center border-2 border-amber-300/50 group-hover:scale-110 group-hover:-rotate-12 transition-transform"><span class="text-4xl group-hover:animate-bounce" style="animation-delay: 0.3s;">üèõÔ∏è</span>
          </div>
          <div class="flex-1">
           <h3 class="title-font text-2xl text-amber-100 mb-1">Sejarah &amp; Peradaban</h3>
           <p class="text-amber-200/80 text-sm mb-3">IPS - Budaya, ekonomi, geografi ‚Ä¢ Mode Sinta (Observasi)</p>
           <div class="flex items-center gap-2">
            <div class="h-2 bg-amber-900/50 rounded-full flex-1">
             <div class="h-2 bg-amber-400 rounded-full progress-bar" style="width: 0%"></div>
            </div><span class="text-xs text-amber-300">Terbuka</span>
           </div>
          </div>
          <div class="flex-shrink-0 text-3xl group-hover:translate-x-1 transition-transform group-hover:animate-pulse">
           ‚Üí
          </div>
         </div>
        </div>
       </div><!-- Chapter 5 (Boss) -->
       <div class="chapter-card group cursor-pointer option-stagger stagger-5 opacity-60" onclick="selectChapter(5)">
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-purple-700 to-violet-900 p-6 border-2 border-purple-400/30 transition-all">
         <div class="absolute inset-0 opacity-20">
          <div class="absolute top-0 right-0 w-40 h-40 bg-purple-400/20 rounded-full blur-3xl animate-pulse"></div>
         </div>
         <div class="relative flex items-center gap-6">
          <div class="flex-shrink-0 w-20 h-20 rounded-xl bg-purple-400/20 flex items-center justify-center border-2 border-purple-400/30 group-hover:scale-110 transition-transform"><span class="text-4xl rotate-spin">üåÄ</span>
          </div>
          <div class="flex-1">
           <h3 class="title-font text-2xl text-purple-200 mb-1">Inti Lupa</h3>
           <p class="text-purple-300/60 text-sm mb-3">Final Boss - Gabungan logika &amp; empati melawan Si Lupa</p>
           <div class="flex items-center gap-2">
            <div class="h-2 bg-purple-900/50 rounded-full flex-1">
             <div class="h-2 bg-purple-400 rounded-full progress-bar" style="width: 0%"></div>
            </div><span class="text-xs text-purple-400">üîí Terkunci</span>
           </div>
          </div>
          <div class="flex-shrink-0 text-3xl text-purple-400/50">
           üîê
          </div>
         </div>
        </div>
       </div>
      </div><!-- Info Box -->
      <div class="bg-indigo-900/50 rounded-xl p-4 border border-indigo-600/30 text-center slide-up">
       <p class="text-purple-300 text-sm">üí° <span class="font-semibold">Tips:</span> Selesaikan 4 chapter pertama untuk membuka Inti Lupa dan mengalahkan Si Lupa!</p>
      </div>
     </div>
    </div><!-- Chapter Info Panel (Hidden by default) -->
    <div id="chapter-info" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
     <div class="dialog-box rounded-2xl p-6 max-w-md w-full slide-up">
      <h3 id="chapter-title" class="title-font text-2xl text-amber-300 mb-3"></h3>
      <p id="chapter-desc" class="text-purple-200 mb-6"></p>
      <div class="space-y-3 mb-4">
       <div class="text-sm text-purple-300">
        <p><span class="font-bold">Mode:</span> <span id="chapter-mode"></span></p>
        <p><span class="font-bold">Mata Pelajaran:</span> <span id="chapter-subject"></span></p>
       </div>
      </div>
      <div class="flex gap-3"><button onclick="playChapter()" class="flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 rounded-xl font-bold transition-all active:scale-95 transform hover:scale-105"> ‚ñ∂Ô∏è Mulai </button> <button onclick="hideChapterInfo()" class="px-4 py-3 bg-purple-700/50 hover:bg-purple-600/50 rounded-xl font-semibold transition-colors"> Batal </button>
      </div>
     </div>
    </div>
   </div><!-- Gameplay Screen -->
   <div id="gameplay-screen" class="min-h-full w-full flex flex-col relative z-10 hidden"><!-- Game Header -->
    <div class="bg-indigo-900/80 backdrop-blur p-3 flex justify-between items-center border-b border-purple-500/30"><button onclick="exitToMap()" class="p-2 bg-purple-700/50 hover:bg-purple-600/50 rounded-lg text-sm hover:scale-110 transform transition-transform"> ‚Üê Peta </button>
     <div class="text-center">
      <p id="gameplay-chapter-title" class="text-amber-300 font-bold text-sm slide-right"></p>
     </div>
     <div class="flex items-center gap-2"><span class="text-emerald-300 pulse">‚≠ê</span> <span id="gameplay-score" class="text-emerald-300 font-bold">0</span>
     </div>
    </div><!-- Story/Dialog Area -->
    <div class="flex-1 flex flex-col p-4 overflow-auto"><!-- Scene Background -->
     <div id="scene-container" class="flex-1 relative rounded-xl overflow-hidden mb-4 min-h-[200px]"><!-- Dynamic scene content will be inserted here -->
     </div><!-- Dialog Box -->
     <div id="dialog-container" class="dialog-box rounded-xl p-4 slide-up">
      <div class="flex items-start gap-3">
       <div id="speaker-avatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex-shrink-0 flex items-center justify-center text-xl bounce-in"><!-- Avatar SVG -->
       </div>
       <div class="flex-1">
        <p id="speaker-name" class="text-amber-300 font-bold text-sm mb-1">Rifki</p>
        <p id="dialog-text" class="text-purple-100 text-sm leading-relaxed"></p>
       </div>
      </div>
     </div><!-- Choice Buttons -->
     <div id="choice-container" class="mt-4 space-y-2 hidden"><!-- Dynamic choices -->
     </div>
    </div><!-- Continue Button -->
    <div class="p-4 bg-indigo-900/50 border-t border-purple-500/30"><button id="continue-dialog-btn" onclick="nextDialog()" class="w-full py-3 bg-gradient-to-r from-purple-600 to-violet-600 hover:from-purple-500 hover:to-violet-500 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 transform"> Lanjutkan ‚ñ∂ </button>
    </div>
   </div><!-- Puzzle Screen -->
   <div id="puzzle-screen" class="min-h-full w-full flex flex-col relative z-10 hidden"><!-- Puzzle Header -->
    <div class="bg-indigo-900/80 backdrop-blur p-3 flex justify-between items-center border-b border-purple-500/30">
     <div class="flex items-center gap-2"><span id="puzzle-mode-icon" class="text-2xl rotate-spin">üî∑</span> <span id="puzzle-mode-text" class="text-blue-300 font-bold text-sm">Mode Rifki</span>
     </div>
     <div class="flex items-center gap-4">
      <div class="flex items-center gap-1"><span id="lives-display">‚ù§Ô∏è</span> <span id="lives-count" class="font-bold">3</span>
      </div>
      <div class="flex items-center gap-1"><span>‚è±Ô∏è</span> <span id="timer-count" class="font-bold">60</span>
      </div>
      <div class="flex items-center gap-1"><span>‚ùì</span> <span id="question-count" class="font-bold">1</span>
      </div>
     </div>
    </div><!-- Puzzle Content -->
    <div class="flex-1 flex flex-col items-center justify-center p-4 overflow-auto">
     <div id="puzzle-container" class="w-full max-w-2xl"><!-- Dynamic puzzle content -->
     </div>
    </div><!-- Puzzle Footer -->
    <div class="p-4 bg-indigo-900/50 border-t border-purple-500/30">
     <div id="puzzle-feedback" class="text-center mb-3 hidden">
      <p id="feedback-text" class="font-bold text-lg"></p>
     </div><button id="submit-puzzle-btn" onclick="submitPuzzle()" class="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-400 hover:to-orange-400 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 transform"> ‚úì Jawab </button>
    </div>
   </div><!-- Achievement Modal -->
   <div id="achievement-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
    <div class="dialog-box rounded-2xl p-6 max-w-md w-full max-h-[80%] overflow-auto slide-up">
     <h2 class="title-font text-2xl text-amber-300 text-center mb-4 slide-down">üèÜ Pencapaian</h2>
     <div id="achievement-list" class="space-y-3"><!-- Dynamic achievements -->
     </div><button onclick="closeModal('achievement-modal')" class="w-full mt-4 py-3 bg-purple-700/50 hover:bg-purple-600/50 rounded-xl font-bold transition-colors hover:scale-105 transform"> Tutup </button>
    </div>
   </div><!-- Encyclopedia Modal -->
   <div id="encyclopedia-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
    <div class="dialog-box rounded-2xl p-6 max-w-lg w-full max-h-[80%] overflow-auto slide-up">
     <h2 class="title-font text-2xl text-amber-300 text-center mb-4 slide-down">üìö Ensiklopedia</h2>
     <div class="grid grid-cols-2 gap-3 mb-4"><button onclick="showEncyclopediaCategory('ipa')" class="p-3 bg-green-600/30 hover:bg-green-500/40 rounded-xl border border-green-500/50 transition-colors transform hover:scale-110"> <span class="text-2xl block mb-1 bounce-in">üî¨</span> <span class="text-green-300 text-sm font-bold">IPA</span> </button> <button onclick="showEncyclopediaCategory('math')" class="p-3 bg-blue-600/30 hover:bg-blue-500/40 rounded-xl border border-blue-500/50 transition-colors transform hover:scale-110"> <span class="text-2xl block mb-1 bounce-in stagger-1">üìê</span> <span class="text-blue-300 text-sm font-bold">Matematika</span> </button> <button onclick="showEncyclopediaCategory('ips')" class="p-3 bg-amber-600/30 hover:bg-amber-500/40 rounded-xl border border-amber-500/50 transition-colors transform hover:scale-110"> <span class="text-2xl block mb-1 bounce-in stagger-2">üåç</span> <span class="text-amber-300 text-sm font-bold">IPS</span> </button> <button onclick="showEncyclopediaCategory('bahasa')" class="p-3 bg-pink-600/30 hover:bg-pink-500/40 rounded-xl border border-pink-500/50 transition-colors transform hover:scale-110"> <span class="text-2xl block mb-1 bounce-in stagger-3">üìù</span> <span class="text-pink-300 text-sm font-bold">Bahasa</span> </button>
     </div>
     <div id="encyclopedia-content" class="text-purple-200 text-sm">
      <p class="text-center text-purple-400">Pilih kategori untuk melihat pengetahuan yang telah kamu kumpulkan!</p>
     </div><button onclick="closeModal('encyclopedia-modal')" class="w-full mt-4 py-3 bg-purple-700/50 hover:bg-purple-600/50 rounded-xl font-bold transition-colors hover:scale-105 transform"> Tutup </button>
    </div>
   </div><!-- Character Info Modal -->
   <div id="character-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden">
    <div class="dialog-box rounded-2xl p-6 max-w-sm w-full slide-up">
     <div id="character-modal-content"><!-- Dynamic character info -->
     </div><button onclick="closeModal('character-modal')" class="w-full mt-4 py-3 bg-purple-700/50 hover:bg-purple-600/50 rounded-xl font-bold transition-colors hover:scale-105 transform"> Tutup </button>
    </div>
   </div><!-- Music Player -->
   <audio id="game-music" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/music/18e87c78-6f59-4e96-bef2-d9ad926d77df/18e87c78-6f59-4e96-bef2-d9ad926d77df-128.mp3" type="audio/mpeg">
   </audio><!-- Music Toggle Button --> <button id="music-toggle" onclick="toggleMusic()" class="fixed top-4 right-4 z-40 p-3 bg-gradient-to-br from-purple-600 to-violet-600 hover:from-purple-500 hover:to-violet-500 rounded-full shadow-lg shadow-purple-500/50 transform transition-all hover:scale-110 active:scale-95 tooltip-container" title="Tap untuk putar musik"> <span id="music-icon" class="text-2xl block rotate-spin-slow">üéµ</span>
    <div class="absolute top-full right-0 mt-2 bg-purple-900/90 text-white text-xs px-3 py-2 rounded-lg whitespace-nowrap opacity-0 pointer-events-none transition-opacity tooltip">
     Tap untuk musik
    </div></button> <!-- Toast Notification -->
   <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-emerald-600 text-white px-6 py-3 rounded-xl shadow-lg z-50 hidden slide-up">
    <p id="toast-message" class="font-bold text-center"></p>
   </div><!-- Loading Overlay -->
   <div id="loading-overlay" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
    <div class="text-center">
     <div class="w-16 h-16 border-4 border-purple-500 border-t-amber-400 rounded-full animate-spin mx-auto mb-4"></div>
     <p class="text-purple-300">Memuat...</p>
    </div>
   </div>
  </div>
  <script>
    // Comprehensive Puzzle Database - 100 Soal Sulit
    const puzzleDatabase = [
      // IPA (30 soal)
      { id: 1, cat: 'ipa', diff: 'sulit', q: 'Proses yang mengubah CO2 dan H2O menjadi glukosa dengan bantuan cahaya disebut?', opts: ['Respirasi', 'Fotosintesis', 'Fermentasi', 'Evaporasi'], ans: 1 },
      { id: 2, cat: 'ipa', diff: 'sulit', q: 'Organela sel yang berfungsi sebagai "pembangkit tenaga" sel adalah?', opts: ['Ribosom', 'Mitokondria', 'Vakuola', 'Lisosom'], ans: 1 },
      { id: 3, cat: 'ipa', diff: 'sulit', q: 'DNA kepanjangan dari?', opts: ['Deoxyribose Nucleic Acid', 'Deoxyribonucleic Acid', 'Diribonucleic Acid', 'Deoxyribose Nucleide'], ans: 1 },
      { id: 4, cat: 'ipa', diff: 'sulit', q: 'Proses pembelahan sel yang menghasilkan 4 sel anak dengan jumlah kromosom setengah dari induk adalah?', opts: ['Mitosis', 'Meiosis', 'Binary Fission', 'Amitosis'], ans: 1 },
      { id: 5, cat: 'ipa', diff: 'sulit', q: 'Lapisan atmosfer tempat pesawat terbang disebut?', opts: ['Troposfer', 'Stratosfer', 'Mesosfer', 'Termosfer'], ans: 1 },
      { id: 6, cat: 'ipa', diff: 'sulit', q: 'Berapakah kedalaman rata-rata Samudera Pasifik?', opts: ['2 km', '3 km', '4 km', '5 km'], ans: 2 },
      { id: 7, cat: 'ipa', diff: 'sulit', q: 'Hewan yang berdarah dingin disebut?', opts: ['Endotermik', 'Ektotermik', 'Homeotermik', 'Poikilotermik'], ans: 3 },
      { id: 8, cat: 'ipa', diff: 'sulit', q: 'Proses penyembuhan luka dengan pertumbuhan jaringan baru disebut?', opts: ['Reparasi', 'Regenerasi', 'Reproduksi', 'Resorpsi'], ans: 1 },
      { id: 9, cat: 'ipa', diff: 'sulit', q: 'Enzyme yang memecah protein menjadi asam amino disebut?', opts: ['Amylase', 'Lipase', 'Protease', 'Kinase'], ans: 2 },
      { id: 10, cat: 'ipa', diff: 'sulit', q: 'Teori evolusi Darwin menyatakan bahwa makhluk hidup berevolusi melalui?', opts: ['Mutasi', 'Seleksi Alam', 'Adaptasi', 'Migrasi'], ans: 1 },
      { id: 11, cat: 'ipa', diff: 'sulit', q: 'Jumlah tulang pada manusia dewasa adalah?', opts: ['186', '196', '206', '216'], ans: 2 },
      { id: 12, cat: 'ipa', diff: 'sulit', q: 'Organ yang menghasilkan insulin adalah?', opts: ['Hati', 'Pankreas', 'Ginjal', 'Jantung'], ans: 1 },
      { id: 13, cat: 'ipa', diff: 'sulit', q: 'Protein yang membawa oksigen dalam darah disebut?', opts: ['Hemoglobin', 'Myoglobin', 'Chlorophyll', 'Melanin'], ans: 0 },
      { id: 14, cat: 'ipa', diff: 'sulit', q: 'Kecepatan cahaya dalam vakum adalah?', opts: ['300.000 km/s', '299.792 km/s', '250.000 km/s', '150.000 km/s'], ans: 1 },
      { id: 15, cat: 'ipa', diff: 'sulit', q: 'Proses konversi energi cahaya menjadi energi kimia terjadi pada?', opts: ['Mitokondria', 'Kloroplas', 'Ribosom', 'Nukleus'], ans: 1 },
      { id: 16, cat: 'ipa', diff: 'sulit', q: 'pH darah manusia normal adalah?', opts: ['6.8-7.0', '7.2-7.4', '7.8-8.0', '8.2-8.4'], ans: 1 },
      { id: 17, cat: 'ipa', diff: 'sulit', q: 'Spesies yang tidak dapat menghasilkan keturunan yang subur adalah?', opts: ['Homozigot', 'Hibrida', 'Haploid', 'Diploid'], ans: 1 },
      { id: 18, cat: 'ipa', diff: 'sulit', q: 'Massa jenis air pada suhu 4¬∞C adalah?', opts: ['0.9 g/cm¬≥', '1.0 g/cm¬≥', '1.1 g/cm¬≥', '1.2 g/cm¬≥'], ans: 1 },
      { id: 19, cat: 'ipa', diff: 'sulit', q: 'Proses transformasi energi dalam tumbuhan dimulai dari?', opts: ['Akar', 'Batang', 'Daun', 'Buah'], ans: 2 },
      { id: 20, cat: 'ipa', diff: 'sulit', q: 'Bakteri pengurai adalah jenis bakteri?', opts: ['Saprofit', 'Parasit', 'Simbiont', 'Komensalis'], ans: 0 },
      { id: 21, cat: 'ipa', diff: 'sulit', q: 'Gaya yang menarik dua benda bermassa disebut?', opts: ['Gravitasi', 'Elektromagnetik', 'Nuklir', 'Gesekan'], ans: 0 },
      { id: 22, cat: 'ipa', diff: 'sulit', q: 'Jumlah kalori yang dibutuhkan untuk menaikkan suhu 1 gram air 1¬∞C disebut?', opts: ['Joule', 'Kalori', 'Watt', 'Pascal'], ans: 1 },
      { id: 23, cat: 'ipa', diff: 'sulit', q: 'Jenis kolesterol yang baik untuk kesehatan disebut?', opts: ['LDL', 'HDL', 'VLDL', 'Trigliserida'], ans: 1 },
      { id: 24, cat: 'ipa', diff: 'sulit', q: 'Proses percepatan laju reaksi kimia tanpa dikonsumsi disebut?', opts: ['Katalisis', 'Hidrolisis', 'Oksidasi', 'Reduksi'], ans: 0 },
      { id: 25, cat: 'ipa', diff: 'sulit', q: 'Planet terdingin di tata surya adalah?', opts: ['Neptunus', 'Uranus', 'Saturnus', 'Jupiter'], ans: 1 },
      { id: 26, cat: 'ipa', diff: 'sulit', q: 'Siklus air di alam dimulai dari?', opts: ['Penguapan', 'Kondensasi', 'Presipitasi', 'Infiltrasi'], ans: 0 },
      { id: 27, cat: 'ipa', diff: 'sulit', q: 'Energi yang tidak dapat diperbaharui adalah?', opts: ['Surya', 'Angin', 'Air', 'Minyak Bumi'], ans: 3 },
      { id: 28, cat: 'ipa', diff: 'sulit', q: 'Organisme yang dapat membuat makanannya sendiri disebut?', opts: ['Heterotraf', 'Autotraf', 'Saprofit', 'Parasit'], ans: 1 },
      { id: 29, cat: 'ipa', diff: 'sulit', q: 'Akibat dari efek rumah kaca adalah?', opts: ['Pendinginan Global', 'Pemanasan Global', 'Penurunan Tekanan', 'Kenaikan Salinitas'], ans: 1 },
      { id: 30, cat: 'ipa', diff: 'sulit', q: 'Bagian otak yang mengontrol keseimbangan adalah?', opts: ['Serebrum', 'Serebelum', 'Medulla', 'Hipotalamus'], ans: 1 },

      // MATEMATIKA (30 soal)
      { id: 31, cat: 'math', diff: 'sulit', q: 'Jika 2^x = 16, berapakah nilai x?', opts: ['2', '4', '6', '8'], ans: 1 },
      { id: 32, cat: 'math', diff: 'sulit', q: 'Akar dari 144 adalah?', opts: ['10', '11', '12', '13'], ans: 2 },
      { id: 33, cat: 'math', diff: 'sulit', q: 'Nilai dari log‚ÇÅ‚ÇÄ(1000) adalah?', opts: ['1', '2', '3', '4'], ans: 2 },
      { id: 34, cat: 'math', diff: 'sulit', q: 'Jika sin(x) = 0.5, maka x = ?', opts: ['30¬∞', '45¬∞', '60¬∞', '90¬∞'], ans: 0 },
      { id: 35, cat: 'math', diff: 'sulit', q: 'Luas lingkaran dengan jari-jari 7 cm adalah?', opts: ['154 cm¬≤', '196 cm¬≤', '308 cm¬≤', '49 cm¬≤'], ans: 0 },
      { id: 36, cat: 'math', diff: 'sulit', q: 'Keliling segitiga dengan sisi 3, 4, 5 adalah?', opts: ['10', '12', '15', '20'], ans: 0 },
      { id: 37, cat: 'math', diff: 'sulit', q: 'Volume kubus dengan sisi 5 cm adalah?', opts: ['25 cm¬≥', '50 cm¬≥', '125 cm¬≥', '250 cm¬≥'], ans: 2 },
      { id: 38, cat: 'math', diff: 'sulit', q: 'Rata-rata dari 2, 4, 6, 8, 10 adalah?', opts: ['4', '5', '6', '7'], ans: 2 },
      { id: 39, cat: 'math', diff: 'sulit', q: 'Median dari 1, 3, 5, 7, 9 adalah?', opts: ['3', '5', '7', '9'], ans: 1 },
      { id: 40, cat: 'math', diff: 'sulit', q: 'Jika x + 5 = 12, maka x = ?', opts: ['5', '6', '7', '8'], ans: 2 },
      { id: 41, cat: 'math', diff: 'sulit', q: 'Berapa persen dari 50 adalah 25?', opts: ['25%', '50%', '75%', '100%'], ans: 1 },
      { id: 42, cat: 'math', diff: 'sulit', q: 'Faktor prima dari 60 adalah?', opts: ['2, 3, 5', '2, 5, 7', '3, 5, 7', '2, 3, 7'], ans: 0 },
      { id: 43, cat: 'math', diff: 'sulit', q: 'KPK dari 12 dan 18 adalah?', opts: ['24', '36', '48', '72'], ans: 1 },
      { id: 44, cat: 'math', diff: 'sulit', q: 'FPB dari 48 dan 64 adalah?', opts: ['8', '12', '16', '32'], ans: 2 },
      { id: 45, cat: 'math', diff: 'sulit', q: '2/3 + 1/4 = ?', opts: ['5/12', '3/7', '11/12', '7/12'], ans: 2 },
      { id: 46, cat: 'math', diff: 'sulit', q: 'Jika y = 2x + 3, dan x = 5, maka y = ?', opts: ['10', '13', '15', '18'], ans: 1 },
      { id: 47, cat: 'math', diff: 'sulit', q: 'Luas trapezium dengan sisi sejajar 4 dan 6, tinggi 5 adalah?', opts: ['20', '25', '30', '35'], ans: 1 },
      { id: 48, cat: 'math', diff: 'sulit', q: 'Keliling lingkaran dengan diameter 14 cm adalah?', opts: ['22 cm', '44 cm', '88 cm', '154 cm'], ans: 1 },
      { id: 49, cat: 'math', diff: 'sulit', q: 'Jika 3x = 9, maka x = ?', opts: ['1', '2', '3', '4'], ans: 2 },
      { id: 50, cat: 'math', diff: 'sulit', q: 'Berapa hasil dari 5¬≤ - 3¬≤ = ?', opts: ['16', '25', '34', '50'], ans: 0 },
      { id: 51, cat: 'math', diff: 'sulit', q: 'Jika œÄ ‚âà 3.14, luas lingkaran r=10 adalah?', opts: ['314', '628', '157', '31.4'], ans: 0 },
      { id: 52, cat: 'math', diff: 'sulit', q: 'Bentuk desimal dari 3/8 adalah?', opts: ['0.25', '0.375', '0.5', '0.625'], ans: 1 },
      { id: 53, cat: 'math', diff: 'sulit', q: 'cos(0¬∞) = ?', opts: ['0', '0.5', '1', 'tak terdefinisi'], ans: 2 },
      { id: 54, cat: 'math', diff: 'sulit', q: 'Nilai dari 10! / 8! = ?', opts: ['72', '90', '100', '120'], ans: 1 },
      { id: 55, cat: 'math', diff: 'sulit', q: 'Berapa banyak diagonal pada segi lima?', opts: ['5', '7', '9', '10'], ans: 0 },
      { id: 56, cat: 'math', diff: 'sulit', q: 'Jika perbandingan x:y = 2:3 dan y = 15, maka x = ?', opts: ['10', '20', '30', '45'], ans: 0 },
      { id: 57, cat: 'math', diff: 'sulit', q: 'Modus dari 1,2,2,3,3,3,4 adalah?', opts: ['1', '2', '3', '4'], ans: 2 },
      { id: 58, cat: 'math', diff: 'sulit', q: 'Jika a = 2 dan b = 3, maka a¬≥ + b¬≤ = ?', opts: ['13', '17', '20', '25'], ans: 1 },
      { id: 59, cat: 'math', diff: 'sulit', q: 'Luas persegi panjang 12 √ó 8 = ?', opts: ['20', '40', '96', '192'], ans: 2 },
      { id: 60, cat: 'math', diff: 'sulit', q: 'Volume balok 5 √ó 4 √ó 3 = ?', opts: ['12', '30', '60', '120'], ans: 2 },

      // IPS (20 soal)
      { id: 61, cat: 'ips', diff: 'sulit', q: 'Candi terbesar di dunia adalah Candi?', opts: ['Prambanan', 'Borobudur', 'Mendut', 'Sambas'], ans: 1 },
      { id: 62, cat: 'ips', diff: 'sulit', q: 'Indonesia terletak di antara dua benua, yaitu?', opts: ['Asia-Afrika', 'Asia-Australia', 'Australia-Eropa', 'Amerika-Asia'], ans: 1 },
      { id: 63, cat: 'ips', diff: 'sulit', q: 'Ibukota Indonesia adalah?', opts: ['Surabaya', 'Jakarta', 'Bandung', 'Medan'], ans: 1 },
      { id: 64, cat: 'ips', diff: 'sulit', q: 'Proclamation of Independence diumumkan pada?', opts: ['15 Agustus 1945', '17 Agustus 1945', '20 Agustus 1945', '1 September 1945'], ans: 1 },
      { id: 65, cat: 'ips', diff: 'sulit', q: 'Pendiri Negara Indonesia adalah?', opts: ['Soekarno saja', 'Hatta saja', 'Soekarno dan Hatta', 'Sudirman'], ans: 2 },
      { id: 66, cat: 'ips', diff: 'sulit', q: 'Jumlah sila dalam Pancasila adalah?', opts: ['3', '4', '5', '6'], ans: 2 },
      { id: 67, cat: 'ips', diff: 'sulit', q: 'Sistem pemerintahan Indonesia adalah?', opts: ['Monarki', 'Presidensial', 'Parlementer', 'Absolut'], ans: 1 },
      { id: 68, cat: 'ips', diff: 'sulit', q: 'Mata uang Indonesia adalah?', opts: ['Sen', 'Rupiah', 'Dollar', 'Euro'], ans: 1 },
      { id: 69, cat: 'ips', diff: 'sulit', q: 'Negara dengan penduduk terbesar di dunia adalah?', opts: ['China', 'India', 'USA', 'Indonesia'], ans: 1 },
      { id: 70, cat: 'ips', diff: 'sulit', q: 'Samudera terbesar di dunia adalah?', opts: ['Atlantik', 'Pasifik', 'Hindia', 'Arktik'], ans: 1 },
      { id: 71, cat: 'ips', diff: 'sulit', q: 'Gunung tertinggi di dunia adalah?', opts: ['K2', 'Everest', 'Denali', 'Kilimanjaro'], ans: 1 },
      { id: 72, cat: 'ips', diff: 'sulit', q: 'Benua terbesar di dunia adalah?', opts: ['Afrika', 'Amerika', 'Asia', 'Antartika'], ans: 2 },
      { id: 73, cat: 'ips', diff: 'sulit', q: 'Negara dengan luas terbesar di dunia adalah?', opts: ['USA', 'China', 'Rusia', 'Kanada'], ans: 2 },
      { id: 74, cat: 'ips', diff: 'sulit', q: 'Sungai terpanjang di dunia adalah?', opts: ['Amazonas', 'Nil', 'Yangtze', 'Mississippi'], ans: 1 },
      { id: 75, cat: 'ips', diff: 'sulit', q: 'Negara yang tidak memiliki laut adalah?', opts: ['Bolivia', 'Nepal', 'Mongolia', 'Semua benar'], ans: 3 },
      { id: 76, cat: 'ips', diff: 'sulit', q: 'Era Reformasi di Indonesia dimulai tahun?', opts: ['1945', '1965', '1998', '2004'], ans: 2 },
      { id: 77, cat: 'ips', diff: 'sulit', q: 'ASEAN didirikan tahun?', opts: ['1945', '1955', '1967', '1975'], ans: 2 },
      { id: 78, cat: 'ips', diff: 'sulit', q: 'PBB didirikan tahun?', opts: ['1945', '1950', '1960', '1970'], ans: 0 },
      { id: 79, cat: 'ips', diff: 'sulit', q: 'Sistem ekonomi Indonesia adalah?', opts: ['Kapitalisme', 'Sosialisme', 'Ekonomi Pancasila', 'Komunitarisme'], ans: 2 },
      { id: 80, cat: 'ips', diff: 'sulit', q: 'Suku terbesar di Indonesia adalah?', opts: ['Sunda', 'Madura', 'Jawa', 'Batak'], ans: 2 },

      // BAHASA (20 soal)
      { id: 81, cat: 'bahasa', diff: 'sulit', q: 'Kata "Lensa" berasal dari bahasa?', opts: ['Jawa', 'Sansekerta', 'Latin', 'Arab'], ans: 2 },
      { id: 82, cat: 'bahasa', diff: 'sulit', q: 'Sinonim dari "sulit" adalah?', opts: ['Mudah', 'Gampang', 'Rumit', 'Ringan'], ans: 2 },
      { id: 83, cat: 'bahasa', diff: 'sulit', q: 'Antonim dari "panjang" adalah?', opts: ['Jauh', 'Pendek', 'Luas', 'Besar'], ans: 1 },
      { id: 84, cat: 'bahasa', diff: 'sulit', q: 'Kata yang memiliki arti sama disebut?', opts: ['Homonim', 'Sinonim', 'Polisemi', 'Antonim'], ans: 1 },
      { id: 85, cat: 'bahasa', diff: 'sulit', q: 'Tanda baca (.) digunakan untuk?', opts: ['Pertanyaan', 'Perintah', 'Akhir kalimat', 'Daftar'], ans: 2 },
      { id: 86, cat: 'bahasa', diff: 'sulit', q: 'Jumlah huruf dalam alfabet adalah?', opts: ['24', '25', '26', '27'], ans: 2 },
      { id: 87, cat: 'bahasa', diff: 'sulit', q: 'Kata "dimensi" berarti?', opts: ['Ukuran', 'Lebar', 'Panjang', 'Tinggi'], ans: 0 },
      { id: 88, cat: 'bahasa', diff: 'sulit', q: 'Bentuk kata kerja "makan" dalam bentuk pasif adalah?', opts: ['Dimakan', 'Termakan', 'Memakan', 'Makanan'], ans: 0 },
      { id: 89, cat: 'bahasa', diff: 'sulit', q: 'Kalimat yang berakhir dengan tanda (?) adalah kalimat?', opts: ['Berita', 'Tanya', 'Perintah', 'Harapan'], ans: 1 },
      { id: 90, cat: 'bahasa', diff: 'sulit', q: 'Majas yang membandingkan dua hal dengan "seperti" adalah?', opts: ['Metafora', 'Simile', 'Personifikasi', 'Hiperbola'], ans: 1 },
      { id: 91, cat: 'bahasa', diff: 'sulit', q: 'Puisi modern tanpa rima disebut?', opts: ['Soneta', 'Pantun', 'Vers bebas', 'Gurindam'], ans: 2 },
      { id: 92, cat: 'bahasa', diff: 'sulit', q: 'Suku kata dalam kata "pembelajaran" adalah?', opts: ['3', '4', '5', '6'], ans: 3 },
      { id: 93, cat: 'bahasa', diff: 'sulit', q: 'Ejaan yang disempurnakan mulai berlaku tahun?', opts: ['1947', '1966', '1972', '1987'], ans: 2 },
      { id: 94, cat: 'bahasa', diff: 'sulit', q: 'Penulis "Laskar Pelangi" adalah?', opts: ['Pramoedya', 'Andrea Hirata', 'Sutan Sjahrir', 'Hamka'], ans: 1 },
      { id: 95, cat: 'bahasa', diff: 'sulit', q: 'Genus yang berarti "cerita" dalam bahasa Latin adalah?', opts: ['Prosa', 'Puisi', 'Drama', 'Fiksi'], ans: 0 },
      { id: 96, cat: 'bahasa', diff: 'sulit', q: 'Kesusastraan merupakan karya yang terbuat dari?', opts: ['Logika', 'Bahasa', 'Seni', 'Imajinasi'], ans: 1 },
      { id: 97, cat: 'bahasa', diff: 'sulit', q: 'Konflik dalam cerita adalah?', opts: ['Awal cerita', 'Pertentangan yang dihadapi', 'Akhir cerita', 'Tokoh utama'], ans: 1 },
      { id: 98, cat: 'bahasa', diff: 'sulit', q: 'Istilah "plot" dalam cerita berarti?', opts: ['Tema', 'Alur', 'Watak', 'Latar'], ans: 1 },
      { id: 99, cat: 'bahasa', diff: 'sulit', q: 'Dialog dalam drama disebut juga?', opts: ['Monolog', 'Prolog', 'Percakapan', 'Dedikasi'], ans: 2 },
      { id: 100, cat: 'bahasa', diff: 'sulit', q: 'Karya tulis yang menceritakan kehidupan nyata disebut?', opts: ['Fiksi', 'Nonfiksi', 'Autobiografi', 'Biografi'], ans: 2 }
    ];

    // Game State
    let gameState = {
      playerName: '',
      currentChapter: 1,
      totalScore: 0,
      completedPuzzles: [],
      unlockedAchievements: [],
      lives: 3,
      currentDialogIndex: 0,
      selectedChapter: null,
      currentPuzzle: null,
      puzzleAnswer: null,
      timerInterval: null,
      savedGameId: null,
      usedPuzzles: [],
      questionsAnswered: 0,
      totalQuestions: 10,
      musicPlaying: false
    };

    // Config untuk editable features
    const defaultConfig = {
      game_title: 'Rifki & Sinta',
      welcome_message: 'Selamat datang, Penjelajah! Dunia pengetahuan menunggumu.',
      background_color: '#0f0a1e',
      text_color: '#e9d5ff',
      primary_action_color: '#10b981',
      secondary_action_color: '#8b5cf6',
      surface_color: '#1e1b4b',
      font_family: 'Nunito',
      font_size: 16
    };

    let config = { ...defaultConfig };

    // Chapter Data
    const chapters = {
      1: { title: 'Gerbang Pengetahuan', desc: 'Tutorial & Bahasa Indonesia', icon: 'üö™', color: 'emerald', unlocked: true },
      2: { title: 'Rimba Bioma', desc: 'IPA - Biologi & Sains', icon: 'üåø', color: 'green', unlocked: true },
      3: { title: 'Kota Numerik', desc: 'Matematika', icon: 'üî¢', color: 'blue', unlocked: true },
      4: { title: 'Sejarah & Peradaban', desc: 'IPS', icon: 'üèõÔ∏è', color: 'amber', unlocked: true },
      5: { title: 'Inti Lupa', desc: 'Final Boss!', icon: 'üåÄ', color: 'purple', unlocked: false }
    };

    // Dialog Scripts
    const dialogScripts = {
      1: [
        { speaker: 'alpha', text: 'Selamat datang di Dimensi Ilmu! Aku Profesor Alpha dari Lensa Kosmos.' },
        { speaker: 'rifki', text: 'Wow! Ini tempat yang luar biasa!' },
        { speaker: 'sinta', text: 'Lihat semua cahaya dan energi yang bergerak!' },
        { speaker: 'alpha', text: 'Kalian siap untuk mengalahkan Si Lupa?' },
        { speaker: 'puzzle', text: 'Mari kita mulai puzzle pertama!' }
      ],
      2: [
        { speaker: 'sinta', text: 'Rimba Bioma! Duniaku! Lihat semua makhluk hidup ini!' },
        { speaker: 'rifki', text: 'Menarik, ada pola-pola ekosistem yang terstruktur.' },
        { speaker: 'alpha', text: 'Puzzle IPA menanti kalian!' },
        { speaker: 'puzzle', text: 'Siap untuk tantangan sains yang lebih sulit?' }
      ],
      3: [
        { speaker: 'rifki', text: 'Kota Numerik! Ini adalah realm-ku!' },
        { speaker: 'sinta', text: 'Semua bentuk geometri yang indah!' },
        { speaker: 'alpha', text: 'Matematika menunggu!' },
        { speaker: 'puzzle', text: 'Puzzle logika dimulai!' }
      ],
      4: [
        { speaker: 'sinta', text: 'Peradaban kuno! Aku bisa merasakan sejarahnya!' },
        { speaker: 'rifki', text: 'Pola kronologi bersejarah yang kompleks.' },
        { speaker: 'alpha', text: 'IPS adalah kunci berikutnya!' },
        { speaker: 'puzzle', text: 'Tantangan sosial dan budaya!' }
      ],
      5: [
        { speaker: 'alpha', text: 'Ini adalah puncak perjalanan kalian...' },
        { speaker: 'silupa', text: 'Hahahaha! Kalian berani datang?!' },
        { speaker: 'rifki', text: 'Kami tidak takut!' },
        { speaker: 'sinta', text: 'Bersama kita pasti bisa!' },
        { speaker: 'puzzle', text: 'Boss Battle - Gabung Logika & Empati!' }
      ]
    };

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        if (data && data.length > 0) {
          const latestSave = data[data.length - 1];
          gameState.savedGameId = latestSave.__backendId;
          gameState.playerName = latestSave.player_name || '';
          gameState.currentChapter = latestSave.current_chapter || 1;
          gameState.totalScore = latestSave.total_score || 0;
          gameState.completedPuzzles = latestSave.completed_puzzles ? latestSave.completed_puzzles.split(',').filter(p => p) : [];
          gameState.unlockedAchievements = latestSave.unlocked_achievements ? latestSave.unlocked_achievements.split(',').filter(a => a) : [];
          
          updatePlayerDisplay();
          document.getElementById('continue-btn').classList.remove('hidden');
          document.getElementById('player-stats').classList.remove('hidden');
        }
      }
    };

    // Initialize SDKs
    async function initializeGame() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              { get: () => cfg.background_color || defaultConfig.background_color, set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
              { get: () => cfg.surface_color || defaultConfig.surface_color, set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
              { get: () => cfg.text_color || defaultConfig.text_color, set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
              { get: () => cfg.primary_action_color || defaultConfig.primary_action_color, set: (v) => { cfg.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); } },
              { get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color, set: (v) => { cfg.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); } }
            ],
            borderables: [],
            fontEditable: { get: () => cfg.font_family || defaultConfig.font_family, set: (v) => { cfg.font_family = v; window.elementSdk.setConfig({ font_family: v }); } },
            fontSizeable: { get: () => cfg.font_size || defaultConfig.font_size, set: (v) => { cfg.font_size = v; window.elementSdk.setConfig({ font_size: v }); } }
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['game_title', cfg.game_title || defaultConfig.game_title],
            ['welcome_message', cfg.welcome_message || defaultConfig.welcome_message]
          ])
        });
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK');
        }
      }

      generateStars();
      applyConfig();
    }

    function applyConfig() {
      const bgColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryAction = config.primary_action_color || defaultConfig.primary_action_color;
      const secondaryAction = config.secondary_action_color || defaultConfig.secondary_action_color;
      const surface = config.surface_color || defaultConfig.surface_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      document.body.style.background = `radial-gradient(ellipse at center, ${surface} 0%, ${bgColor} 50%, ${bgColor} 100%)`;
      document.body.style.color = textColor;
      document.body.style.fontFamily = `${fontFamily}, Nunito, sans-serif`;
      document.body.style.fontSize = `${fontSize}px`;

      document.getElementById('game-title').textContent = config.game_title || defaultConfig.game_title;
      document.getElementById('welcome-msg').textContent = config.welcome_message || defaultConfig.welcome_message;
    }

    function toggleMusic() {
      const audio = document.getElementById('game-music');
      const icon = document.getElementById('music-icon');
      
      if (gameState.musicPlaying) {
        audio.pause();
        gameState.musicPlaying = false;
        icon.classList.add('paused');
        showToast('üîá Musik Dimatikan');
      } else {
        audio.play().catch(err => {
          console.error('Gagal memutar musik:', err);
          showToast('Musik tidak tersedia');
        });
        gameState.musicPlaying = true;
        icon.classList.remove('paused');
        showToast('üéµ Musik Diputar');
      }
    }

    function generateStars() {
      const container = document.getElementById('stars-container');
      container.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'absolute rounded-full bg-white star-twinkle';
        star.style.width = Math.random() * 3 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 2 + 's';
        container.appendChild(star);
      }
    }

    function updatePlayerDisplay() {
      document.getElementById('player-name-display').textContent = gameState.playerName;
      document.getElementById('player-score-display').textContent = gameState.totalScore;
      document.getElementById('map-player-name').textContent = gameState.playerName;
      document.getElementById('map-score').textContent = gameState.totalScore;
      document.getElementById('gameplay-score').textContent = gameState.totalScore;
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-message').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showLoading(show) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function showScreen(screenId) {
      ['main-menu', 'name-input-screen', 'world-map', 'gameplay-screen', 'puzzle-screen'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden');
    }

    function startNewGame() {
      showScreen('name-input-screen');
    }

    async function confirmName() {
      const nameInput = document.getElementById('player-name-input').value.trim();
      if (!nameInput) {
        showToast('Masukkan namamu terlebih dahulu!');
        return;
      }

      gameState.playerName = nameInput;
      gameState.currentChapter = 1;
      gameState.totalScore = 0;
      gameState.completedPuzzles = [];
      gameState.unlockedAchievements = [];

      showLoading(true);

      if (window.dataSdk) {
        const result = await window.dataSdk.create({
          player_name: gameState.playerName,
          current_chapter: gameState.currentChapter,
          total_score: gameState.totalScore,
          completed_puzzles: '',
          unlocked_achievements: '',
          last_played: new Date().toISOString(),
          current_difficulty: 'sulit'
        });

        if (!result.isOk) {
          showToast('Gagal menyimpan permainan');
        }
      }

      showLoading(false);
      updatePlayerDisplay();
      showScreen('world-map');
      showToast(`Selamat datang, ${gameState.playerName}!`);
    }

    function continueGame() {
      updatePlayerDisplay();
      showScreen('world-map');
    }

    function returnToMenu() {
      showScreen('main-menu');
    }

    function selectChapter(chapterNum) {
      const chapter = chapters[chapterNum];
      if (!chapter.unlocked) {
        showToast('Chapter ini masih terkunci!');
        return;
      }

      gameState.selectedChapter = chapterNum;
      
      document.getElementById('chapter-title').textContent = `${chapter.icon} ${chapter.title}`;
      document.getElementById('chapter-desc').textContent = chapter.desc;
      
      const modeInfo = {
        1: { mode: 'Tutorial', subject: 'Bahasa Indonesia' },
        2: { mode: 'Sinta (Observasi)', subject: 'IPA - Biologi' },
        3: { mode: 'Rifki (Logika)', subject: 'Matematika' },
        4: { mode: 'Sinta (Observasi)', subject: 'IPS' },
        5: { mode: 'Dual Mode', subject: 'Semua' }
      };
      
      const info = modeInfo[chapterNum] || {};
      document.getElementById('chapter-mode').textContent = info.mode || 'Standar';
      document.getElementById('chapter-subject').textContent = info.subject || '';
      
      document.getElementById('chapter-info').classList.remove('hidden');
    }

    function hideChapterInfo() {
      document.getElementById('chapter-info').classList.add('hidden');
    }

    function playChapter() {
      hideChapterInfo();
      gameState.currentDialogIndex = 0;
      gameState.lives = 3;
      gameState.usedPuzzles = [];
      gameState.questionsAnswered = 0;
      
      document.getElementById('gameplay-chapter-title').textContent = chapters[gameState.selectedChapter].title;
      
      showScreen('gameplay-screen');
      renderScene();
      renderDialog();
    }

    function exitToMap() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
      }
      showScreen('world-map');
    }

    function renderScene() {
      const chapter = chapters[gameState.selectedChapter];
      const sceneContainer = document.getElementById('scene-container');
      
      const sceneGradients = {
        1: 'from-indigo-600 to-purple-800',
        2: 'from-green-600 to-emerald-800',
        3: 'from-blue-600 to-indigo-800',
        4: 'from-amber-600 to-orange-800',
        5: 'from-purple-800 to-violet-950'
      };

      sceneContainer.innerHTML = `
        <div class="absolute inset-0 bg-gradient-to-b ${sceneGradients[gameState.selectedChapter]} flex items-center justify-center">
          <div class="text-center">
            <span class="text-6xl md:text-8xl block mb-4 bounce-in">${chapter.icon}</span>
            <p class="text-xl md:text-2xl font-bold text-white/80 slide-up">${chapter.title}</p>
          </div>
        </div>
      `;
    }

    function renderDialog() {
      const dialogs = dialogScripts[gameState.selectedChapter];
      if (gameState.currentDialogIndex >= dialogs.length) {
        startPuzzle();
        return;
      }

      const dialog = dialogs[gameState.currentDialogIndex];
      const speakerName = document.getElementById('speaker-name');
      const dialogText = document.getElementById('dialog-text');
      const avatar = document.getElementById('speaker-avatar');

      const speakers = {
        rifki: { name: 'Rifki', color: 'from-blue-400 to-blue-600', emoji: 'üë¶' },
        sinta: { name: 'Sinta', color: 'from-pink-400 to-rose-500', emoji: 'üëß' },
        alpha: { name: 'Profesor Alpha', color: 'from-amber-400 to-orange-500', emoji: 'üåü' },
        silupa: { name: 'Si Lupa', color: 'from-purple-600 to-violet-800', emoji: 'üåÄ' },
        puzzle: { name: 'Sistem', color: 'from-emerald-400 to-teal-500', emoji: 'üéÆ' }
      };

      const speaker = speakers[dialog.speaker];
      speakerName.textContent = speaker.name;
      dialogText.textContent = dialog.text;
      avatar.className = `w-12 h-12 rounded-full bg-gradient-to-br ${speaker.color} flex-shrink-0 flex items-center justify-center text-xl bounce-in`;
      avatar.textContent = speaker.emoji;

      if (dialog.speaker === 'puzzle') {
        document.getElementById('continue-dialog-btn').textContent = 'Mulai Puzzle üß©';
      } else {
        document.getElementById('continue-dialog-btn').textContent = 'Lanjutkan ‚ñ∂';
      }
    }

    function nextDialog() {
      gameState.currentDialogIndex++;
      renderDialog();
    }

    // Get random puzzle dari database
    function getRandomPuzzle() {
      let categoryMap = { 1: 'bahasa', 2: 'ipa', 3: 'math', 4: 'ips', 5: 'all' };
      let targetCategory = categoryMap[gameState.selectedChapter];
      
      let availablePuzzles = puzzleDatabase.filter(p => {
        if (targetCategory === 'all') return !gameState.usedPuzzles.includes(p.id);
        return p.cat === targetCategory && !gameState.usedPuzzles.includes(p.id);
      });

      if (availablePuzzles.length === 0) {
        gameState.usedPuzzles = [];
        availablePuzzles = puzzleDatabase.filter(p => {
          if (targetCategory === 'all') return true;
          return p.cat === targetCategory;
        });
      }

      const randomPuzzle = availablePuzzles[Math.floor(Math.random() * availablePuzzles.length)];
      gameState.usedPuzzles.push(randomPuzzle.id);
      return randomPuzzle;
    }

    function startPuzzle() {
      const puzzle = getRandomPuzzle();
      gameState.currentPuzzle = puzzle;
      gameState.puzzleAnswer = null;

      const modeMap = { 'bahasa': ['Bahasa', 'üî∂'], 'ipa': ['IPA', 'üî∂'], 'math': ['Matematika', 'üî∑'], 'ips': ['IPS', 'üî∂'], 'all': ['Dual Mode', '‚ö°'] };
      const [mode, icon] = modeMap[puzzle.cat] || ['Unknown', '‚ùì'];

      document.getElementById('puzzle-mode-icon').textContent = icon;
      document.getElementById('puzzle-mode-text').textContent = mode;
      document.getElementById('lives-count').textContent = gameState.lives;
      document.getElementById('question-count').textContent = gameState.questionsAnswered + 1;
      document.getElementById('puzzle-feedback').classList.add('hidden');

      renderPuzzle();
      showScreen('puzzle-screen');
      startTimer();
    }

    function renderPuzzle() {
      const puzzle = gameState.currentPuzzle;
      const container = document.getElementById('puzzle-container');

      container.innerHTML = `
        <div class="text-center mb-8 question-slide">
          <p class="text-lg text-purple-200 mb-4">${puzzle.q}</p>
        </div>
        <div class="grid grid-cols-1 gap-3">
          ${puzzle.opts.map((opt, idx) => `
            <button onclick="selectAnswer(${idx})" 
              class="puzzle-cell p-4 bg-indigo-800/50 hover:bg-indigo-700/50 rounded-xl text-white text-left border-2 border-transparent transition-all option-stagger"
              style="animation-delay: ${idx * 0.1}s"
              data-option="${idx}">
              <span class="inline-block w-8 h-8 rounded-full bg-purple-600 text-center leading-8 mr-3 font-bold">${String.fromCharCode(65 + idx)}</span>
              ${opt}
            </button>
          `).join('')}
        </div>
      `;
    }

    function selectAnswer(idx) {
      document.querySelectorAll('[data-option]').forEach(btn => {
        btn.classList.remove('border-amber-400', 'bg-amber-500/30');
        btn.classList.add('border-transparent');
      });
      document.querySelector(`[data-option="${idx}"]`).classList.add('border-amber-400', 'bg-amber-500/30');
      document.querySelector(`[data-option="${idx}"]`).classList.remove('border-transparent');
      gameState.puzzleAnswer = idx;
    }

    function startTimer() {
      let timeLeft = 60;
      document.getElementById('timer-count').textContent = timeLeft;
      
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
      }

      gameState.timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer-count').textContent = timeLeft;
        
        if (timeLeft <= 0) {
          clearInterval(gameState.timerInterval);
          handleWrongAnswer();
        }
      }, 1000);
    }

    async function submitPuzzle() {
      const puzzle = gameState.currentPuzzle;

      if (gameState.puzzleAnswer === null) {
        showToast('Pilih jawaban terlebih dahulu!');
        return;
      }

      clearInterval(gameState.timerInterval);

      const isCorrect = gameState.puzzleAnswer === puzzle.ans;

      if (isCorrect) {
        await handleCorrectAnswer();
      } else {
        handleWrongAnswer();
      }
    }

    async function handleCorrectAnswer() {
      const feedbackEl = document.getElementById('puzzle-feedback');
      const feedbackText = document.getElementById('feedback-text');
      
      feedbackEl.classList.remove('hidden');
      feedbackText.textContent = '‚ú® Benar! Luar biasa! ‚ú®';
      feedbackText.className = 'font-bold text-emerald-400 text-lg bounce-in';

      gameState.totalScore += 100;
      gameState.questionsAnswered++;
      
      if (!gameState.completedPuzzles.includes(String(gameState.selectedChapter))) {
        gameState.completedPuzzles.push(String(gameState.selectedChapter));
      }

      // Check achievements
      if (gameState.completedPuzzles.length === 1 && !gameState.unlockedAchievements.includes('first_puzzle')) {
        gameState.unlockedAchievements.push('first_puzzle');
        showToast('üèÜ Pencapaian: Pemula!');
      }

      const chapterAchievements = {
        1: 'chapter_1', 2: 'chapter_2', 3: 'chapter_3', 4: 'chapter_4', 5: 'boss_defeated'
      };
      const achId = chapterAchievements[gameState.selectedChapter];
      if (!gameState.unlockedAchievements.includes(achId)) {
        gameState.unlockedAchievements.push(achId);
      }

      if ([1,2,3,4].every(c => gameState.completedPuzzles.includes(String(c)))) {
        chapters[5].unlocked = true;
      }

      await saveGame();
      updatePlayerDisplay();

      // Continue to next question or back to map
      if (gameState.questionsAnswered < gameState.totalQuestions) {
        setTimeout(() => {
          showToast(`+100 Poin! Total: ${gameState.totalScore}`);
          startPuzzle();
        }, 2000);
      } else {
        setTimeout(() => {
          showToast(`üéâ Chapter Selesai! Poin Total: ${gameState.totalScore}`);
          showScreen('world-map');
        }, 2000);
      }
    }

    function handleWrongAnswer() {
      const feedbackEl = document.getElementById('puzzle-feedback');
      const feedbackText = document.getElementById('feedback-text');
      
      gameState.lives--;
      document.getElementById('lives-count').textContent = gameState.lives;
      document.getElementById('lives-display').classList.add('shake-animation');
      
      setTimeout(() => {
        document.getElementById('lives-display').classList.remove('shake-animation');
      }, 500);

      if (gameState.lives <= 0) {
        feedbackEl.classList.remove('hidden');
        feedbackText.textContent = 'üåÄ Kabut Lupa Menang...';
        feedbackText.className = 'font-bold text-red-400 text-lg';
        
        document.getElementById('puzzle-container').classList.add('blur-effect');
        
        setTimeout(() => {
          document.getElementById('puzzle-container').classList.remove('blur-effect');
          gameState.lives = 3;
          showScreen('world-map');
        }, 3000);
      } else {
        feedbackEl.classList.remove('hidden');
        feedbackText.textContent = `‚ùå Salah! Sisa Nyawa: ${gameState.lives}`;
        feedbackText.className = 'font-bold text-amber-400 text-lg';
        
        setTimeout(() => {
          feedbackEl.classList.add('hidden');
          startTimer();
        }, 1500);
      }
    }

    async function saveGame() {
      if (!window.dataSdk || !gameState.savedGameId) return;

      showLoading(true);
      const result = await window.dataSdk.update({
        __backendId: gameState.savedGameId,
        player_name: gameState.playerName,
        current_chapter: gameState.currentChapter,
        total_score: gameState.totalScore,
        completed_puzzles: gameState.completedPuzzles.join(','),
        unlocked_achievements: gameState.unlockedAchievements.join(','),
        last_played: new Date().toISOString(),
        current_difficulty: 'sulit'
      });

      showLoading(false);
      
      if (!result.isOk) {
        showToast('Gagal menyimpan permainan');
      }
    }

    // Modal Functions
    function showAchievements() {
      const achievements = [
        { id: 'first_puzzle', name: 'Pemula', desc: 'Selesaikan puzzle pertama', icon: 'üåü' },
        { id: 'chapter_1', name: 'Penjelajah', desc: 'Selesaikan Chapter 1', icon: 'üö™' },
        { id: 'chapter_2', name: 'Naturalis', desc: 'Selesaikan Rimba Bioma', icon: 'üåø' },
        { id: 'chapter_3', name: 'Matematikawan', desc: 'Selesaikan Kota Numerik', icon: 'üî¢' },
        { id: 'chapter_4', name: 'Sejarawan', desc: 'Selesaikan Sejarah', icon: 'üèõÔ∏è' },
        { id: 'boss_defeated', name: 'Pahlawan', desc: 'Kalahkan Si Lupa', icon: 'üëë' }
      ];

      const list = document.getElementById('achievement-list');
      list.innerHTML = achievements.map((ach, i) => {
        const unlocked = gameState.unlockedAchievements.includes(ach.id);
        return `
          <div class="flex items-center gap-3 p-3 rounded-lg option-stagger ${unlocked ? 'bg-amber-500/20 border border-amber-500/50' : 'bg-purple-900/30 border border-purple-500/30 opacity-50'}" style="animation-delay: ${i * 0.05}s;">
            <span class="text-2xl ${unlocked ? '' : 'grayscale'}">${ach.icon}</span>
            <div>
              <p class="font-bold ${unlocked ? 'text-amber-300' : 'text-purple-400'}">${ach.name}</p>
              <p class="text-sm ${unlocked ? 'text-purple-200' : 'text-purple-500'}">${ach.desc}</p>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('achievement-modal').classList.remove('hidden');
    }

    function showEncyclopedia() {
      document.getElementById('encyclopedia-modal').classList.remove('hidden');
    }

    function showEncyclopediaCategory(category) {
      const content = document.getElementById('encyclopedia-content');
      const categoryNames = { ipa: 'IPA', math: 'Matematika', ips: 'IPS', bahasa: 'Bahasa Indonesia' };
      const puzzles = puzzleDatabase.filter(p => p.cat === category).slice(0, 5);
      
      content.innerHTML = `<h3 class="font-bold text-amber-300 mb-3">${categoryNames[category]}</h3>` + 
        puzzles.map(p => `
          <div class="p-3 bg-purple-900/30 rounded-lg mb-2 border border-purple-500/30 text-xs">
            <p class="text-purple-200"><strong>Q:</strong> ${p.q}</p>
          </div>
        `).join('');
    }

    function showCharacterInfo(character) {
      const modal = document.getElementById('character-modal');
      const content = document.getElementById('character-modal-content');
      
      const characters = {
        rifki: {
          name: 'Rifki',
          role: 'Ahli Logika & Matematika',
          color: 'from-blue-400 to-blue-600',
          emoji: 'üë¶',
          desc: 'Pemuda logis ahli dalam angka dan pola!',
          skills: ['Puzzle Angka', 'Logika', 'Analisis']
        },
        sinta: {
          name: 'Sinta',
          role: 'Ahli Observasi & Empati',
          color: 'from-pink-400 to-rose-500',
          emoji: 'üëß',
          desc: 'Gadis observatif ahli dalam pemahaman konteks!',
          skills: ['Observasi', 'Pemahaman', 'Empati']
        }
      };

      const char = characters[character];
      content.innerHTML = `
        <div class="text-center">
          <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br ${char.color} flex items-center justify-center mb-4 border-4 border-white/30 bounce-in">
            <span class="text-4xl">${char.emoji}</span>
          </div>
          <h3 class="title-font text-2xl text-amber-300 mb-1">${char.name}</h3>
          <p class="text-purple-300 text-sm mb-4">${char.role}</p>
          <p class="text-purple-200 text-sm mb-4">${char.desc}</p>
          <div class="flex flex-wrap gap-2 justify-center">
            ${char.skills.map((skill, i) => `
              <span class="px-3 py-1 bg-purple-600/30 rounded-full text-xs text-purple-200 border border-purple-500/50 option-stagger" style="animation-delay: ${i * 0.1}s;">${skill}</span>
            `).join('')}
          </div>
        </div>
      `;
      
      modal.classList.remove('hidden');
    }

    // Initialize on load
    initializeGame();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c1f1159c7298bce',t:'MTc2OTA4NTA4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
